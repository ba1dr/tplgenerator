#!/bin/sh

CUR_DIR=`pwd`
# this line for automatic run only
# CUR_DIR=$(dirname $(readlink -f $0))
BASE_DIR=/opt/<%= @project_name %>
LOG_DIR=/var/log/<%= @project_name %>
CFGDIR=/usr/local/etc/
CFGFILE="<%= @project_name %>.yaml"
PROJ_USER=<%= @project_name %>
# PYTHON=python
PYTHON=python3
PIP=pip3

# ---

# create swap file (optional)
SWAPFILE=/swapfile
sudo fallocate -l 4G $SWAPFILE
sudo chmod 600 $SWAPFILE
sudo mkswap $SWAPFILE
sudo swapon $SWAPFILE

sudo sh -c "echo \"/swapfile   none    swap    sw    0   0\" >> /etc/fstab"


[ "$PYTHON" == "python3" ] && PIP=pip3

sudo useradd -m -U $PROJ_USER
# sudo adduser $PROJ_USER
# sudo adduser $PROJ_USER sudo

# directories/permissions
sudo mkdir -p $BASE_DIR
sudo chown -R $PROJ_USER: $BASE_DIR
sudo chmod -R a+rwX $BASE_DIR
sudo chmod -R -t $BASE_DIR

sudo chmod a+rwX /tmp
sudo chmod -t /tmp

sudo mkdir -p $LOG_DIR
sudo chown -R $PROJ_USER: $LOG_DIR
sudo chmod -R a+rwX $LOG_DIR
sudo chmod -R -t $LOG_DIR

sudo service apache2 stop
sudo update-rc.d -f apache2 disable

sudo apt-get update
sudo apt-get install -y git nginx mc htop screen
sudo apt-get install -y $PYTHON $PYTHON-dev $PYTHON-yaml

cd /tmp/
wget https://bootstrap.pypa.io/get-pip.py
sudo $PYTHON get-pip.py
cd -

sudo $PIP install virtualenv

sudo $PIP install ipython

sudo apt-get install -y libxml2-dev libxslt-dev libjpeg-dev libpng12-dev libfreetype6-dev zlibc zlib1g-dev python3-lxml
sudo apt-get install -y libpq-dev

cd $BASE_DIR
# git clone ! HERE get code
# git clone git@bitbucket.org:PATHPATHPATHPATH ./

# For development server install also:
# sass
# coffee
# npm install

virtualenv venv
. ./venv/bin/activate

# $PIP install -r config/pip/requirements.txt

sudo rm /etc/nginx/sites-enabled/default
sudo ln -s $BASE_DIR/config/nginx/<%= @project_name %>.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/<%= @project_name %>.conf /etc/nginx/sites-enabled/

# fix permissions if were broken
sudo chown -R $PROJ_USER: $BASE_DIR
sudo chmod -R a+rwX $BASE_DIR
sudo chmod -R -t $BASE_DIR

# HERE we copy default config file to /usr/local/etc/ - EDIT IT and set correct local settings!
sudo cp $BASE_DIR/config/$CFGFILE $CFGDIR
sudo chown $PROJ_USER: $CFGDIR/$CFGFILE
sudo chmod 660 $CFGDIR/$CFGFILE

echo "from .production import *" > $BASE_DIR/<%= @project_name %>/settings/local.py

# create startup script
sudo ln -s $BASE_DIR/config/init.d/<%= @project_name %>.conf /etc/init.d/<%= @project_name %>
sudo chmod a+x /etc/init.d/<%= @project_name %>
sudo chown root: /etc/init.d/<%= @project_name %>

# The next line - only for development server (uncomment there):
# gulp build

# HERE do *MANUAL* setup your database - create schema, user, permissions
# See ./postgres/db_setup.sh

$PYTHON ./manage.py syncdb
$PYTHON ./manage.py collectstatic --noinput

sudo service nginx restart
